void 0===Craft.Smith&&(Craft.Smith={}),function(t){Craft.Smith.Init=Garnish.Base.extend({smithMenus:[],init:function(e){Garnish.requestAnimationFrame(t.proxy(function(){for(var e=Garnish.$doc.find(".matrix-field"),i=0;i<e.length;i++)for(var a=t(e[i]),n=a.find("> .blocks > .matrixblock"),s=0;s<n.length;s++){var o=t(n[s]),r=o.find(".actions .settings.menubtn").data("menubtn")||!1;if(!r)return;this.smithMenus.push(new Craft.Smith.Menu(a,o,n,r))}Garnish.on(Craft.MatrixInput,"blockAdded",t.proxy(this,"blockAdded")),Craft.SuperTable&&Craft.SuperTable.MatrixInputAlt&&Garnish.on(Craft.SuperTable.MatrixInputAlt,"blockAdded",t.proxy(this,"blockAdded"))},this))},blockAdded:function(e){Garnish.requestAnimationFrame(t.proxy(function(){var i=e.target.$container,a=i.find("> .blocks > .matrixblock"),n=t(e.$block),s=n.find(".actions .settings.menubtn").data("menubtn")||!1;s?(t.each(this.smithMenus,function(t,e){e.$matrixBlocks=a}),this.smithMenus.push(new Craft.Smith.Menu(i,n,a,s))):this.blockAdded(e)},this))}}),Craft.Smith.Menu=Garnish.Base.extend({init:function(e,i,a,n){this.$matrixField=e,this.$matrixBlock=i,this.$matrixBlocks=a,this.menuBtn=n,this.menu=n.menu;var s=this.menu.$container.find('a[data-action="delete"]').parents("li");this.$copyBtn=t('<a data-icon="copy" data-action="copy">'+Craft.t("app","Copy")+"</a>"),this.$pasteBtn=t('<a data-icon="paste" data-action="paste">'+Craft.t("app","Paste")+"</a>"),this.$cloneBtn=t('<a data-icon="clone" data-action="clone">'+Craft.t("app","Clone")+"</a>"),this.$copyBtn.insertBefore(s).wrap("<li/>"),this.$pasteBtn.insertBefore(s).wrap("<li/>"),this.$cloneBtn.insertBefore(s).wrap("<li/>"),t('<hr class="padded">').insertBefore(s),this.menu.addOptions(this.$copyBtn),this.menu.addOptions(this.$pasteBtn),this.menu.addOptions(this.$cloneBtn),this.menu.on("optionselect",t.proxy(this,"onOptionSelect")),this.menu.on("show",t.proxy(this,"onMenuShow")),this.checkPaste()},onMenuShow:function(t){this.checkPaste()},onOptionSelect:function(e){var i=t(e.selectedOption);i.hasClass("disabled")||i.hasClass("sel")||("copy"==i.data("action")&&this.copyBlock(e),"paste"==i.data("action")&&this.pasteBlock(e),"clone"==i.data("action")&&this.cloneBlock(e))},checkPaste:function(){var t=!1;try{var e=JSON.parse(localStorage.getItem("smith:block")),i=this.$matrixField.attr("id"),a=e.field,n=new RegExp("leistungen(Morgen|Mittag|Abend)");e&&n.test(i)&&n.test(a)?t=!0:e&&i.includes("fields-"+e.field)&&(t=!0)}catch(t){}t?this.$pasteBtn.enable():this.$pasteBtn.disable()},copyBlock:function(t){var e=this._serializeBlocks();localStorage.setItem("smith:block",JSON.stringify(e));var i=e.blocks.length,a=1==i?"1 block copied":"{n} blocks copied";Craft.cp.displayNotice(Craft.t("app",a,{n:i})),this.checkPaste()},pasteBlock:function(e,i){try{if(!i)i=JSON.parse(localStorage.getItem("smith:block"));if(new RegExp("leistungen(Morgen|Mittag|Abend)").test(i.field)){var a=this.$matrixField.attr("id");a.includes("Morgen")?i.field="leistungenMorgen":a.includes("Mittag")?i.field="leistungenMittag":a.includes("Abend")&&(i.field="leistungenAbend")}this.$matrixField.find(".blocks");var n=t('<div class="spinner smith-spinner"></div>').insertAfter(this.$matrixBlock),s=this.$matrixField.data("matrix"),o=n;i.placeholderKey=s.settings.placeholderKey,Craft.postActionRequest("smith/field/render-matrix-blocks",i,t.proxy(function(t,e){if("success"===e&&t.success)for(var i=0;i<t.blocks.length;i++){var a=t.blocks[i],r=s.blockTypesByHandle[a.typeHandle];s.blockTypesByHandle[a.typeHandle]=a;s.addBlock(a.typeHandle,o);s.blockTypesByHandle[a.typeHandle]=r}n.remove()},this))}catch(e){}},cloneBlock:function(t){var e=this._serializeBlocks();this.pasteBlock(t,e)},_serializeBlocks:function(){var e={field:"",namespace:"",blocks:[]},i=this.$matrixField.data("matrix"),a=i.blockSelect.$selectedItems;e.placeholderKey=i.settings.placeholderKey,a.length||(a=this.$matrixBlock);for(var n=0;n<a.length;n++){var s=t(a[n]),o=Garnish.getPostData(s);if(s.parents(".field").length>1){var r={};for(var l in o){var c=l.replace(/^fields.+?(fields])/gm,"fields");e.namespace=l.match(/^fields.+?(fields])/gm)[0],r[c]=o[l]}var d=Craft.expandPostArray(r)}else d=Craft.expandPostArray(o);var h=d.fields;for(var f in h)for(var p in e.field=f,h[f].blocks){var u=h[f].blocks[p];u.blockId=s.data("id"),e.blocks.push(u)}}return e=this.filterBlocks(e)},filterBlocks:function(t){var e=this;if(t.blocks&&(t.blocks=t.blocks.filter(function(t){return null!=t}),t.sortOrder)){for(var i=[],a=0;a<t.blocks.length;a++)i.push(a);t.sortOrder=i}return Object.keys(t).forEach(function(i){var a=t[i];if(Array.isArray())for(var n=0;n<a.length;n++)e.filterBlocks(a[n]);"object"==typeof a&&e.filterBlocks(a)}),t}})}(jQuery);
// # sourceMappingURL=smith.js.map
