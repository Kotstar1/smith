void 0===Craft.Smith&&(Craft.Smith={}),function(t){Craft.Smith.Init=Garnish.Base.extend({init:function(i){Garnish.requestAnimationFrame(t.proxy((function(){for(var i=Garnish.$doc.find(".matrix-field"),a=0;a<i.length;a++)for(var e=t(i[a]),n=e.find("> .blocks > .matrixblock"),s=0;s<n.length;s++){var o=t(n[s]),r,c=o.find(".actions .settings.menubtn").data("menubtn")||!1;if(!c)return;new Craft.Smith.Menu(e,o,n,c)}Garnish.on(Craft.MatrixInput,"blockAdded",t.proxy(this,"blockAdded"))}),this))},blockAdded:function(i){Garnish.requestAnimationFrame(t.proxy((function(){var a=i.target.$container,e=a.find("> .blocks > .matrixblock"),n=t(i.$block),s,o=n.find(".actions .settings.menubtn").data("menubtn")||!1;o?new Craft.Smith.Menu(a,n,e,o):this.blockAdded(i)}),this))}}),Craft.Smith.Menu=Garnish.Base.extend({init:function(i,a,e,n){this.$matrixField=i,this.$matrixBlock=a,this.$matrixBlocks=e,this.menuBtn=n,this.menu=n.menu;var s=this.menu.$container.find('a[data-action="delete"]').parents("li");this.$copyBtn=t('<a data-icon="copy" data-action="copy">'+Craft.t("app","Copy")+"</a>"),this.$pasteBtn=t('<a data-icon="paste" data-action="paste">'+Craft.t("app","Paste")+"</a>"),this.$cloneBtn=t('<a data-icon="clone" data-action="clone">'+Craft.t("app","Clone")+"</a>"),this.$copyBtn.insertBefore(s).wrap("<li/>"),this.$pasteBtn.insertBefore(s).wrap("<li/>"),this.$cloneBtn.insertBefore(s).wrap("<li/>"),t('<hr class="padded">').insertBefore(s),this.menu.addOptions(this.$copyBtn),this.menu.addOptions(this.$pasteBtn),this.menu.addOptions(this.$cloneBtn),this.menu.on("optionselect",t.proxy(this,"onOptionSelect")),this.checkPaste()},onOptionSelect:function(i){var a=t(i.selectedOption);a.hasClass("disabled")||a.hasClass("sel")||("copy"==a.data("action")&&this.copyBlock(i),"paste"==a.data("action")&&this.pasteBlock(i),"clone"==a.data("action")&&this.cloneBlock(i))},checkPaste:function(){var t=!1;try{var i=JSON.parse(localStorage.getItem("smith:block")),a=this.$matrixField.attr("id").replace("fields-","");i&&i.field==a&&(t=!0)}catch(t){}t?this.$pasteBtn.enable():this.$pasteBtn.disable()},copyBlock:function(t){var i=this._serializeBlocks();localStorage.setItem("smith:block",JSON.stringify(i));var a=i.blocks.length,e=1==a?"1 block copied":"{n} blocks copied";Craft.cp.displayNotice(Craft.t("app",e,{n:a})),this.checkPaste()},pasteBlock:function(i,a){try{if(!a)var a=JSON.parse(localStorage.getItem("smith:block"));var e=this.$matrixField.find(".blocks"),n=t('<div class="spinner smith-spinner"></div>').insertAfter(this.$matrixBlock),s=this.$matrixField.data("matrix"),o=null;this.$matrixBlocks.each(t.proxy((function(i,a){if(this.$matrixBlock.data("id")==t(a).data("id")){var e=this.$matrixBlocks[i+1];if(e)return o=t(e)}}),this)),Craft.postActionRequest("smith/field/render-matrix-blocks",a,t.proxy((function(t,i){if("success"===i&&t.success)for(var a=0;a<t.blocks.length;a++){var e=t.blocks[a],r=s.blockTypesByHandle[e.typeHandle];s.blockTypesByHandle[e.typeHandle]=e;var c=s.addBlock(e.typeHandle,o);s.blockTypesByHandle[e.typeHandle]=r}n.remove()}),this))}catch(i){}},cloneBlock:function(t){var i=this._serializeBlocks();this.pasteBlock(t,i)},_countInstances:function(t,i){return t.split(i).length-1},_serializeBlocks:function(){var t={field:"",blocks:[]},i,a=this.$matrixField.data("matrix").blockSelect.$selectedItems;a.length||(a=[this.$matrixBlock]);for(var e=0;e<a.length;e++){var n=a[e],s=Garnish.getPostData(n),o,r=Craft.expandPostArray(s).fields,c=!1;for(var l in s)this._countInstances(l,"[blocks]")>1&&(c=!0);if(c)for(var d in r)for(var h in r[d].blocks)for(var f in r[d].blocks[h].fields)for(var p in t.field=f,r[d].blocks[h].fields[f].blocks){var k=r[d].blocks[h].fields[f].blocks[p];t.blocks.push(k)}else for(var f in r)for(var p in t.field=f,r[f].blocks){var k=r[f].blocks[p];t.blocks.push(k)}}return t}})}(jQuery);
//# sourceMappingURL=smith.js.map