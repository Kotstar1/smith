void 0===Craft.Smith&&(Craft.Smith={}),function(t){Craft.Smith.Init=Garnish.Base.extend({smithMenus:[],init:function(e){Garnish.requestAnimationFrame(t.proxy((function(){for(var e=Garnish.$doc.find(".matrix-field"),i=0;i<e.length;i++)for(var a=t(e[i]),s=a.find("> .blocks > .matrixblock"),n=0;n<s.length;n++){var r=t(s[n]),o,l=r.find(".actions .settings.menubtn").data("menubtn")||!1;if(!l)return;this.smithMenus.push(new Craft.Smith.Menu(a,r,s,l))}Garnish.on(Craft.MatrixInput,"blockAdded",t.proxy(this,"blockAdded")),Craft.SuperTable&&Craft.SuperTable.MatrixInputAlt&&Garnish.on(Craft.SuperTable.MatrixInputAlt,"blockAdded",t.proxy(this,"blockAdded"))}),this))},blockAdded:function(e){Garnish.requestAnimationFrame(t.proxy((function(){var i=e.target.$container,a=i.find("> .blocks > .matrixblock"),s=t(e.$block),n,r=s.find(".actions .settings.menubtn").data("menubtn")||!1;r?(t.each(this.smithMenus,(function(t,e){e.$matrixBlocks=a})),this.smithMenus.push(new Craft.Smith.Menu(i,s,a,r))):this.blockAdded(e)}),this))}}),Craft.Smith.Menu=Garnish.Base.extend({init:function(e,i,a,s){this.$matrixField=e,this.$matrixBlock=i,this.$matrixBlocks=a,this.menuBtn=s,this.menu=s.menu;var n=this.menu.$container.find('a[data-action="delete"]').parents("li");this.$copyBtn=t('<a data-icon="copy" data-action="copy">'+Craft.t("app","Copy")+"</a>"),this.$pasteBtn=t('<a data-icon="paste" data-action="paste">'+Craft.t("app","Paste")+"</a>"),this.$cloneBtn=t('<a data-icon="clone" data-action="clone">'+Craft.t("app","Clone")+"</a>"),this.$copyBtn.insertBefore(n).wrap("<li/>"),this.$pasteBtn.insertBefore(n).wrap("<li/>"),this.$cloneBtn.insertBefore(n).wrap("<li/>"),t('<hr class="padded">').insertBefore(n),this.menu.addOptions(this.$copyBtn),this.menu.addOptions(this.$pasteBtn),this.menu.addOptions(this.$cloneBtn),this.menu.on("optionselect",t.proxy(this,"onOptionSelect")),this.menu.on("show",t.proxy(this,"onMenuShow")),this.checkPaste()},onMenuShow:function(t){this.checkPaste()},onOptionSelect:function(e){var i=t(e.selectedOption);i.hasClass("disabled")||i.hasClass("sel")||("copy"==i.data("action")&&this.copyBlock(e),"paste"==i.data("action")&&this.pasteBlock(e),"clone"==i.data("action")&&this.cloneBlock(e))},checkPaste:function(){var t=!1;try{var e=JSON.parse(localStorage.getItem("smith:block")),i=this.$matrixField.attr("id");e&&i.includes("fields-"+e.field)&&(t=!0)}catch(t){}t?this.$pasteBtn.enable():this.$pasteBtn.disable()},copyBlock:function(t){var e=this._serializeBlocks();localStorage.setItem("smith:block",JSON.stringify(e));var i=e.blocks.length,a=1==i?"1 block copied":"{n} blocks copied";Craft.cp.displayNotice(Craft.t("app",a,{n:i})),this.checkPaste()},pasteBlock:function(e,i){try{if(!i)var i=JSON.parse(localStorage.getItem("smith:block"));var a=this.$matrixField.find(".blocks"),s=t('<div class="spinner smith-spinner"></div>').insertAfter(this.$matrixBlock),n=this.$matrixField.data("matrix"),r=null;this.$matrixBlocks.each(t.proxy((function(e,i){if(this.$matrixBlock.data("id")==t(i).data("id")){var a=this.$matrixBlocks[e+1];if(a)return r=t(a)}}),this)),i.placeholderKey=n.settings.placeholderKey,Craft.postActionRequest("smith/field/render-matrix-blocks",i,t.proxy((function(t,e){if("success"===e&&t.success)for(var i=0;i<t.blocks.length;i++){var a=t.blocks[i],o=n.blockTypesByHandle[a.typeHandle];n.blockTypesByHandle[a.typeHandle]=a;var l=n.addBlock(a.typeHandle,r);n.blockTypesByHandle[a.typeHandle]=o}s.remove()}),this))}catch(e){}},cloneBlock:function(t){var e=this._serializeBlocks();this.pasteBlock(t,e)},_serializeBlocks:function(){var e={field:"",namespace:"",blocks:[]},i=this.$matrixField.data("matrix"),a=i.blockSelect.$selectedItems;e.placeholderKey=i.settings.placeholderKey,a.length||(a=this.$matrixBlock);for(var s=0;s<a.length;s++){var n=t(a[s]),r=Garnish.getPostData(n),o,l;if(n.parents(".field").length>1){var c={};for(var h in r){var d=h.replace(/^fields.+?(fields])/gm,"fields");e.namespace=h.match(/^fields.+?(fields])/gm)[0],c[d]=r[h]}var f=Craft.expandPostArray(c)}else var f=Craft.expandPostArray(r);var p=f.fields;for(var u in p)for(var k in e.field=u,p[u].blocks){var m=p[u].blocks[k];m.blockId=n.data("id"),e.blocks.push(m)}}return e=this.filterBlocks(e)},filterBlocks:function(t){var e=this;if(t.blocks&&(t.blocks=t.blocks.filter((function(t){return null!=t})),t.sortOrder)){for(var i=[],a=0;a<t.blocks.length;a++)i.push(a);t.sortOrder=i}return Object.keys(t).forEach((function(i){var a=t[i];if(Array.isArray())for(var s=0;s<a.length;s++)e.filterBlocks(a[s]);"object"==typeof a&&e.filterBlocks(a)})),t}})}(jQuery);
//# sourceMappingURL=smith.js.map